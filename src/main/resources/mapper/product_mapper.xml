<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.ProductMapper">
  <select id="findAllBySeller" resultType="com.example.demo.dto.ProductDto$Summary">
    SELECT p.id as id, p.seller, p.name, p.price, p.sales_count, p.review_count, case when review_count=0 then 0 else total_rating/review_count end as rating,
    '${url}'||(select pi.name from product_image pi where pi.product_id=p.id and rownum=1) as image from product p
    where seller=#{seller} order by p.id offset (#{pageno}-1) * #{pagesize} rows fetch next #{pagesize} rows only
  </select>

  <select id="findAll" resultType="com.example.demo.dto.ProductDto$Summary">
    SELECT p.id as id, p.seller, p.name, p.price, p.sales_count, p.review_count, case when review_count=0 then 0 else total_rating/review_count end as rating,
    '${url}'||(select pi.name from product_image pi where pi.product_id=p.id and rownum=1) as image from product p
    order by p.id offset (#{pageno}-1) * #{pagesize} rows fetch next #{pagesize} rows only
  </select>

  <select id="count" resultType="int">
    select count(*) from product
    <where>
      <if test="seller != null">seller = #{seller} </if>
    </where>
  </select>

  <update id="update">
    update product
    <trim suffixOverrides="," prefix="set">
      <if test="dto.info!=null">info=#{dto.info},</if>
      <if test="dto.stock!=null">stock=#{dto.stock},</if>
    </trim>
    where id=#{dto.id}
  </update>

  <!-- 둘 이상의 1:N를 한번에 처리하기는 매우 복잡하다 -->
  <resultMap id="productMap" type="com.example.demo.dto.ProductDto$Read">
    <id property="id" column="id" />
    <result property="name" column="name" />
    <result property="info" column="info" />
    <result property="price" column="price" />
    <result property="reviewCount" column="review_count" />
    <result property="stock" column="stock" />
    <result property="seller" column="seller" />
    <result property="rating" column="rating" />
    <collection property="reviews" ofType="com.example.demo.entity.product.Review" javaType="java.util.List">
      <id property="id" column="rid" />
      <result property="writer" column="writer" />
      <result property="content" column="content" />
      <result property="rating" column="r_rating" />
      <result property="writeTime" column="write_time" />
    </collection>
  </resultMap>
  <select id="findById" resultMap="productMap">
    select p.id, p.name, p.info, p.price, p.review_count, p.stock, p.seller,
    case when p.review_count=0 then 0 else p.total_rating/p.review_count end as rating,
    r.id as rid, r.writer, r.content, r.rating as r_rating, r.write_time
    from product p left outer join review r on p.id=r.product_id where p.id=#{id}
  </select>
</mapper>